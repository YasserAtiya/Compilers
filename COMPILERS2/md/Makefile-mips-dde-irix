REGOFFSET = "-DREGOFFSET=16"

DFLAGS = $(REGOFFSET) -DDISPOSE -DMUSTALIGN -O -I. -I../lib -DSTACHE -DCALLGRAPH -DDDE -DSCHED=1
SFLAGS = $(REGOFFSET) -DDISPOSE -DMUSTALIGN -S -I. -I../lib -DSTACHE -DCALLGRAPH -DDDE -DSCHED=1

ifeq ($(OSTYPE),solaris)
        LFLAGS = -L../tools/pdtool/ -lxnet -lm -lpdtool
else
        LFLAGS = -L../tools/pdtool/ -lm -lpdtool
endif


YACC = ../tools/yacc/ouryacc
YYFAST = ../tools/yyfast/yyfast
REGTOOL = ../tools/regtool/regtool

TARGET_MACH = mips-dde

COBJECTS = ../lib/live.c sched.c  rtl.c regs.c simp.c dde_inst.c inst.c isem.c y.tab.c linstinfo.c \
	../lib/scan.c ../lib/assign.c ../lib/locals.c ../lib/measure.c  \
	placement.c graph_dummy.c graph_output_io.c graph_interface.c dde.c
OBJECTS = live.o sched.o rtl.o regs.o simp.o inst.o dde_inst.o isem.o y.tab.o linstinfo.o scan.o \
	assign.o locals.o placement.o graph_dummy.o graph_output_io.o  \
	graph_interface.o dde.o

vpo.out: $(OBJECTS) ../lib/lib.$(TARGET_MACH).a
	$(CC) -o vpo.out $(OBJECTS) ../lib/lib.$(TARGET_MACH).a $(LFLAGS)
	cp vpo.out ../../../driver/install/$(TARGET_MACH)/vpo.out

frames.o: ../lib/vpo.h regs.h frames.c
	$(CC) $(EXTRADFLAGS) $(DFLAGS) $(CFLAGS) -I../lib -c frames.c

dde.o: ../lib/vpo.h ../lib/assign.h regs.h dde.c
	$(CC) $(EXTRADFLAGS) $(DFLAGS) $(CFLAGS) -I../lib -c dde.c

graph_interface.o: ../lib/vpo.h ../lib/assign.h regs.h graph_interface.c
	$(CC) $(EXTRADFLAGS) $(DFLAGS) $(CFLAGS) -I../lib -c graph_interface.c

rtl.o: ../lib/vpo.h ../lib/assign.h ../lib/cdmotion.h ../lib/combine.h ../lib/database.h ../lib/links.h ../lib/misc.h ../lib/vectors.h simp.h regs.h rtl.h rtl.c
	$(CC) $(EXTRADFLAGS) $(DFLAGS) $(CFLAGS) -I../lib -c rtl.c

regs.o: ../lib/vpo.h ../lib/assign.h ../lib/links.h ../lib/locals.h ../lib/misc.h ../lib/vectors.h rtl.h instdef.h regs2.h regs.h regs.c
	$(CC) $(EXTRADFLAGS) $(DFLAGS) $(CFLAGS) -c -I../lib regs.c

simp.o: ../lib/vpo.h ../lib/links.h ../lib/misc.h regs.h simp.h simp.c
	$(CC) $(EXTRADFLAGS) $(DFLAGS) $(CFLAGS) -c -I../lib simp.c

inst.o: ../lib/vpo.h recdef.h addrdef.h instdef.h inst.h inst.c
	$(CC) $(EXTRADFLAGS) $(DFLAGS) $(CFLAGS) -c -I../lib inst.c

isem.o: ../lib/vpo.h addrdef.h recdef.h inst.h isem.h isem.c
	$(CC) $(EXTRADFLAGS) $(DFLAGS) $(CFLAGS) -c -I../lib isem.c

live.o: ../lib/live.c *.h ../lib/*.h
	$(CC) $(EXTRADFLAGS) $(DFLAGS) $(CFLAGS) -c -I../lib ../lib/live.c

sched.o: ../lib/vpo.h addrdef.h recdef.h inst.h isem.h sched.c sched.h regs.h regs2.h
	$(CC) $(EXTRADFLAGS) $(DFLAGS) $(CFLAGS) -c -I../lib sched.c

y.tab.c y.tab.h: md.y
	$(YACC) -df md.y
	$(YYFAST) y.tab.c y.new.c
	mv y.new.c y.tab.c

y.tab.o: y.tab.h recdef.h addrdef.h y.tab.c
	$(CC) $(EXTRADFLAGS) $(DFLAGS) $(CFLAGS) -c y.tab.c

linstinfo.o: ../lib/vpo.h ../lib/assign.h ../lib/misc.h addrdef.h recdef.h instdef.h regs.h regs2.h rtl.h linstinfo.h linstinfo.c
	$(CC) $(EXTRADFLAGS) $(DFLAGS) $(CFLAGS) -I../lib -c linstinfo.c

regs.h: regs.rt
	$(REGTOOL) regs.rt regs.h

assign.o: regs.h ../lib/vpo.h ../lib/assign.c ../lib/vpo2.h ../lib/vectors.h ../lib/database.h ../lib/misc.h ../lib/controlflow.h ../lib/links.h ../lib/dataflow.h ../lib/assign.h regs2.h
	$(CC) $(EXTRADFLAGS) $(CFLAGS) $(DFLAGS) -I../$(TARGET_MACH) -c ../lib/assign.c

locals.o: regs.h ../lib/vpo.h ../lib/locals.c ../lib/assign.h ../lib/cdmotion.h ../lib/controlflow.h ../lib/dataflow.h ../lib/links.h ../lib/misc.h ../lib/vectors.h ../lib/vpo2.h regs2.h rtl.h
	$(CC) $(EXTRADFLAGS) $(CFLAGS) $(DFLAGS) -I../$(TARGET_MACH) -c ../lib/locals.c

scan.o: ../lib/vpo.h ../lib/vpo2.h ../lib/scan.h y.tab.h ../lib/scan.c ../lib/scan2.h
	$(CC) $(EXTRADFLAGS) $(CFLAGS) $(DFLAGS) -I../$(TARGET_MACH) -c ../lib/scan.c

placement.o: placement.h placement.c

clean:
	rm -f *.o vpo.out vpo-ease.out core lout regs.h y.tab.*

clean-minor:
	rm -f *.o core lout regs.h y.tab.*

hdrs: regs.h y.tab.h
